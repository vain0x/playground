# AA木

AA木は平衡2分探索木の一種で、赤黒木の亜種

[AA木 - Wikipedia](https://ja.wikipedia.org/wiki/AA%E6%9C%A8)

左ノードの赤を認めないような感じのもの。
リバランスの処理が少なくなるのでコードが少なくなることと、平衡性が高くなるので検索が速くなる、らしい。
逆に平衡性の条件が厳しいので、リバランス時の回転処理は増える

色の代わりにレベルを使う。
赤黒木には、ノードからリーフへのパスに含まれる黒ノードの個数がどのパスでも一定という性質がある。
その黒ノードの個数のことをレベルと呼ぶことにする。

用語:

- ノードから左の子ノードへのリンクを **左リンク** と呼ぶことにする。同様に右の子ノードへのリンクを右リンクと呼ぶ
- ノードから子ノードへのリンクで、両方のノードのレベルが等しいものを **水平リンク** と呼ぶ。
    - ツリーを図示するときにレベルの同じノードを横に並べると、水平リンクは水平な矢印で描画されて、直感的に分かりやすい

制約:

- (リーフ制約) リーフのレベルは1
- 親子間のレベルに制限がある。レベルLのノードについて、その左右の子ノードのレベルは次のように制限される
    - (左制約) 左の子ノードのレベルは `L-1` に等しい
    - (右制約) 右の子ノードのレベルは `L-1` または `L` に等しい
- (孫制約) レベルLのノードについて、その右の子ノードの、さらに右の子ノードのレベルは `L-1` か `L-2` に等しい

制約の備考:

- レベルは木の規模を表しているので、リーフのレベルは1になる
- レベル1のノードがリーフとは限らない
    - 左の子ノードは持たない。(左制約から、左の子ノードのレベルは0でなければいけない。そんなノードは存在しない)
    - 右の子ノードはありうる (水平リンク)。それはリーフである
- 左制約は、赤黒木でいえば「黒の左の子ノードは常に黒」といいかえられる
- 右制約は、赤黒木でいえば「黒の右の子ノードは黒または赤」といいかえられる
- 孫制約は、赤黒木でいえば「赤ノードが連続しないこと」といいかえられる

操作:

リバランスのために、skew, split という基本的な操作を使う。詳細はWikipediaや実装を参照

skewは条件つきの右回転である。
挿入や削除などの操作の後、ノードの左リンクが水平リンクになることがあって、左制約に違反する。そのときに右回転を行うことで解決する

典型的には左のサブツリーに要素を挿入したときに起こる。
例えば1要素からなるツリーに、小さい要素を挿入すると、左ノードにリーフが追加されるが、これは水平リンクになっている

```
            ルート
             |
             v
    [1] <-- [2]
     ^
     挿入した要素
```

skewにより右回転する。左への水平リンクが右への水平リンクになる

```
    ルート
     |
     v
    [1] --> [2]
```

skewはノードのレベルを変えない

splitは条件つきの左回転であり、さらにノードのレベルを上げる。
木の成長を表している。
挿入などの操作の後、ノードの右の水平リンクが連続することがあって、それは孫制約に違反する。そのときに左回転を行うことで解決する

典型的には水平リンクを持つ右のノードに要素を挿入したときに起こる。
前述の通り左に要素を追加するとskewにより右への水平リンクが発生するので、splitはいずれ起こるものである。
例えば前述の木 (`Map.of [1; 2]`) に要素3を挿入したとする。skewは起きない。splitが起こる

```
    ルート
     |
     v
    [1] --> [2] --> [3]
                     ^ 挿入した要素
```

splitにより左回転し、さらに新たにルートになったノードのレベルが2になる

```
           ルート
            |
            v
     +---- [2](Lv.2) ----+
     |                   |
     v                   v
    [1]                 [3]
```
